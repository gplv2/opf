 <!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>opf</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/libphonenumber-js/1.1.11/libphonenumber-js.min.js" integrity="sha256-WpMe4MJBE9YQsdLF6GgaKw881rFAOqKEH3Hy+0xj3As=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.css" integrity="sha256-iYUgmrapfDGvBrePJPrMWQZDcObdAcStKBpjP3Az+3s=" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.js" integrity="sha256-CNm+7c26DTTCGRQkM9vp7aP85kHFMqs9MhPEuytF+fQ=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.2/leaflet.draw.css" integrity="sha256-XzD3RpaHPv7lzX9qt+2n1j5cWj48O24KsgaGYpKN8x8=" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.2/leaflet.draw.js" integrity="sha256-jzmB6xy6L0YPzPeu+ccUiPKp3UE+qRmo5xmq5BbnSv0=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" integrity="sha256-pMhcV6/TBDtqH9E9PWKgS+P32PVguLG8IipkPyqMtfY=" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js" integrity="sha256-XWzSUJ+FIQ38dqC06/48sNRwU1Qh3/afjmJ080SneA8=" crossorigin="anonymous"></script>
    <!-- <script src="https://raw.githubusercontent.com/osmlab/osm-auth/master/osmauth.min.js"></script> -->

    <style type="text/css">
      h1, h2, p, label, span, table, td, th {
        font-family: Avenir,Helvetica,Arial,sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        color: #344d50;
      }
      table, td, th {
        border: 1px solid #344d50;
        white-space: nowrap;
      }
      table {
        border-collapse: collapse;
      }
      @media only screen and (min-width: 40em) {
        body {
          margin-top: 6vh;
          margin-left: 6vw;
        }
      }
      .tagline {
        margin-bottom: 2px;
      }
      .tagline+p {
        margin-top: 0;
        font-style: italic;
      }
      #b-box-map {
        height: 30em;
        max-width: 40em;
      }
      #custom-regex {
        visibility: hidden;
      }
      #query {
        display: inline-block;
        border: solid 1px #000;
        min-height: 9em;
        max-height: 30em;
        min-width: 14em;
        max-width: 70em;
        overflow: scroll;
        font-family: Consolas, monaco, monospace;
        font-size: 9pt;
      }
      #query-recalculate {
        margin-top: 1em;
      }
      form > div {
        margin-bottom: 0.2em;
      }
      hr {
        max-width: 25em;
      }

      .main-elem {
        background-color: hsl(0, 0%, 94%);
      }
      .formatted {
        color: #5386b1;
      }
      .checked-state {
        color: white;
        background-color: orange;
      }
      .checked {
        background-color: #53b162;
      }
    </style>

  </head>
  <body>
    <h1 class="tagline">OPF - OSM Phone Formatter</h1>
    <p>Easily fix the formatting of phone and fax numbers on OpenStreetMap.</p>

    <p>Follow the  steps below to </p>

    <h2 class="tagline">Step 1: get data</h2>
    <p>Fetch suspicsious data from the overpass API.</p>

    <form id="query-form">
      <div id="b-box-map"></div>
      <span id="b-box-coords"></span><br>
      <span id="b-box-wha"></span>
      <div>
        <input type="checkbox" id="fax" name="fax" checked>
        <label for="fax">Also scan for fax=* tags?</label>
      </div>
      <div>
        <input type="checkbox" id="contact-variants" name="contact-variants" checked>
        <label for="contact-variants">Also scan for the 'contact:' variants?</label>
      </div>
      <div>
        <label for="regex-picker">Which regex to use?</label><br>
        <select id="regex-picker" name="regex-picker">
          <option value="all">Catch all</option>
          <option value="suspicious">Catch only with suspicious chars or groupings</option>
          <option value="custom">Custom</option>
        </select>
      </div>
      <div>
        <input id="regex-pattern" type="text" name="regex-pattern">
      </div>
      <div>
        <button id="query-recalculate" type="submit">Recalculate</button>
      </div>
    </form>

    <hr align="left">
    <div>
      <label>Resulting Overpass query: <br><i>(without output or special tags)</i></label><br>
      <div id="query" name="Overpass query" contentEditable="true"> </div>
    </div>

    <button id="overpass-fetch">Fetch</button>


    <h2>Step 2: format data</h2>

    <p>Use the button below to format the data fetched from the overpass API using libphonenumber-js. First check and correct the data (you can edit it in the 'final' collumn). When an entry looks right, click the 'checked' collumn on that entry. You can also click the collumn header to toggle all entries at once.</p>
    <button id="format-data">Format</button><br><br>
    <table id="opfData">
      <colgroup>
<!--         <col span="1" style="width: 1em;">
        <col span="1" style="width: 7em;">
        <col span="1" style="width: 6em;"> -->
      </colgroup>

      <thead>
        <tr>
          <th>#</th>
          <th>Osm ID</th>
          <th>Key</th>
          <th>Original</th>
          <th>Formatted</th>
          <th id="checked-header">Checked</th>
        </tr>
      </thead>

      <tbody>
      </tbody>
    </table> 


    <h2>Step 3: upload data</h2>
  
  <script type="text/javascript">
    function getKeyByValue(obj, value) {
      for (var prop in obj) {
        if (obj.hasOwnProperty(prop)) {
          if(obj[ prop ] === value)
            return prop;
        }
      }
    }

    function appendToTableBody(tableBody, data, customClasses, customAttrib) {
      tr = document.createElement("tr");
      for (customClass of customClasses) {
        tr.classList.add(customClass);
      }
      for (customAttrib of customAttrib) {
        tr.setAttribute(customAttrib.name, customAttrib.value); 
      }
      for (k in data) {
        td = document.createElement("td");
        v = document.createTextNode(data[k]);
        td.appendChild(v);
        tr.appendChild(td);
      }
      tableBody.appendChild(tr);  '[index="'+elem.index+'"][subIndex="'+elem.subIndex+'"]'
    }

    function appendToTableRow(tableRow, data, customClasses, customAttrib) {
      td = document.createElement("td");
      for (customClass of customClasses) {
        td.classList.add(customClass);
      }
      for (customAttrib of customAttrib) {
        td.setAttribute(customAttrib.name, customAttrib.value); 
      }
      v = document.createTextNode(data);
      td.appendChild(v);
      tableRow.appendChild(td);
    }    

    var defaultBBox = [[50.8762690879832,4.695570588046395],[50.882964426809274,4.7061771154403695]];

    var bBoxCoords;

    var formatted = false;

    var checkedAll = false;

    var opfData = []

    var regexPatterns = {
      all: ".",
      suspicious: "^\\+[0-9]{2,2}(\\s[0-9]{2,3}){1,10}$"
    }

    var queryParts = {
      start: "[out:json][timeout:30];\n(\n",
      elems: ["node", "way", "relation"],
      keys: ['phone', 'fax', 'contact:phone', 'contact:fax'],
      end: ");\nout meta;"
    }

    document.addEventListener('DOMContentLoaded', init, false);

    function init() {
      document.getElementById("query-recalculate").addEventListener("click", function(e){
        e.preventDefault();
        recalculateQuery(e);
      });
      document.getElementById("overpass-fetch").addEventListener("click", function() {
        if (!opfData.length || window.confirm('This will overwrite all data below. Are you sure?'))
          fetchOverpassData(recalculateQuery());
      });
      document.getElementById("format-data").addEventListener("click", function() {
        if (!formatted || window.confirm('This will overwrite all already formatted data below. Are you sure?'))
          formatData();
      });
      document.getElementById("checked-header").addEventListener("click", function() {
        toggleCheckedAll();
      });
      document.getElementById("regex-picker").onchange = regexPicked;
      document.getElementById("regex-pattern").oninput = regexChanged;
      document.getElementById("regex-pattern").value = regexPatterns.all;

      initLeaflet();
    }

    function initLeaflet() {
      var bBoxMap = L.map('b-box-map');
      var osm = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(bBoxMap);
      // FeatureGroup is to store editable layers
      var drawnItems = new L.FeatureGroup();
      drawnItems.addTo(bBoxMap);

      var drawControl = new L.Control.Draw({
        edit: {
          featureGroup: drawnItems,
          remove: false
        },
        draw: {
          featureGroup: drawnItems,
          rectangle: {
            enable: true,
            showArea:true,
            metric: ['km', 'm']
          },
          polygon: false,
          marker: false,
          circle: false,
          polyline: false,
          circlemarker: false
        }
      });

      bBox = L.rectangle(defaultBBox);
      bBox.addTo(drawnItems);
      updateBBoxInfo(bBox.getLatLngs()[0]);
      bBoxMap.fitBounds(defaultBBox);

      bBoxMap.addControl(drawControl);

      bBoxMap.on('draw:created', function(event) {
        var layer = event.layer;
        drawnItems.eachLayer(function(layer) {
          drawnItems.removeLayer(layer);
        });  
        drawnItems.addLayer(layer);

        updateBBoxInfo(layer._defaultShape());
      });

      // Object(s) edited - update popups
      bBoxMap.on('draw:edited', function(event) {
        var layers = event.layers;
        layers.eachLayer(function(layer) {
          updateBBoxInfo(layer._defaultShape())
        });
      });
    }

    var updateBBoxInfo = function(latlngs) {
      bBoxCoords = [latlngs[0]['lat'], latlngs[0]['lng'], latlngs[2]['lat'], latlngs[2]['lng']]
      height = Math.round(latlngs[0].distanceTo(latlngs[1]));
      width = Math.round(latlngs[0].distanceTo(latlngs[3]));
      area = Math.round(L.GeometryUtil.geodesicArea(latlngs));
      document.getElementById('b-box-coords').innerHTML = 'Bounding box: ' + bBoxCoords.toString();
      document.getElementById('b-box-wha').innerHTML = 'Width: ' + width + 'm&emsp;Height: ' + height + 'm&emsp;Area: ' + area + 'm&sup2;';
    }

    var regexPicked = function(e) {
      var pattern = regexPatterns[e.target.value];
      if (pattern)
        document.getElementById('regex-pattern').value = pattern;
    }

    var regexChanged = function(e) {
      var pattern = document.getElementById('regex-pattern').value;
      var name = getKeyByValue(regexPatterns, pattern);
      name = name == undefined ? 'custom' : name;
      document.getElementById('regex-picker').value = name;
    }

    var recalculateQuery = function(e) {
      fax = document.getElementById('fax').checked;
      contactVariants = document.getElementById('contact-variants').checked;
      regex = document.getElementById('regex-pattern').value;
      
      var query = queryParts.start;

      var keys = queryParts.keys.slice(0, 1);
      if (fax)
        keys.push(queryParts.keys.slice(1, 2));
      if (contactVariants)
        keys.push(queryParts.keys.slice(2, 4));

      keys.forEach(function(key) {
        for (var j = 0; j < queryParts.elems.length; j++) {
          query = query.concat('  ',queryParts.elems[j],'["',key,'"~"',regex,'"](',bBoxCoords.toString(),');\n');
        }
      });

      query = query.concat(queryParts.end)

      document.getElementById('query').innerHTML = query.replace(/ /g, '&nbsp').replace(/(?:\r\n|\r|\n)/g, '<br />');

      return query;
    }

    var parseOverpassData = function(elements) {
      tableBody = document.getElementById("opfData").getElementsByTagName('tbody')[0];

      opfData = [];
      i = 0;

      for (elem of elements) {
        opfData.push({
          index: i,
          mainKey: true,
          origElem: elem
        });
        appendToTableBody(tableBody, [
          i,
          elem.id
        ], ['main-elem'], [{name: 'index', 'value': i}]);
        queryParts.keys.forEach(function(key, j) {
          if (elem.tags[key]) {
            opfData.push({
              index: i,
              subIndex: j,
              mainKey: false,
              key: key,
              numOriginal: elem.tags[key]
            });
            appendToTableBody(tableBody, [
              ' ',
              ' ',
              key,
              elem.tags[key]
            ], ['sub-elem'], [{name: 'index', value: i}, {name: 'subIndex', value: j}]);
          }
        });
        i++;
      }
    }

    var fetchOverpassData = function(query) {
      console.log('Fetching overpass data...');
      NProgress.start()

      deleteData();

      req = new XMLHttpRequest();
      req.open("POST", "https://overpass-api.de/api/interpreter");
      req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

      req.onreadystatechange = function() {
        if (req.readyState == XMLHttpRequest.DONE) {
          NProgress.done()
          if (req.status == 200) {
            json = JSON.parse(req.response)
            if (json.elements != undefined) {
              console.log('Fetched overpass data')
              parseOverpassData(json.elements);
            }
          } else {
            console.log('Overpass request failed: ' + req.status + ': ' + req.statusText)
          }
        }
      }

      req.send('data='.concat(encodeURIComponent(query)));
    }

    var formatData = function() {
      if (formatted)
        deleteFormatData();
      tableBody = document.getElementById("opfData").getElementsByTagName('tbody')[0];
      for (elem of opfData) {
        if (!elem.mainKey) {
          formatted = libphonenumber.formatNumber({phone: cleanPrefix(elem.numOriginal), country: 'BE'}, 'International');
          elem['numFormatted'] = formatted;
          elem['checked'] = false;
          row = tableBody.querySelector('[index="'+elem.index+'"][subIndex="'+elem.subIndex+'"]');
          appendToTableRow(row, formatted, ['formatted'], [{name: 'contentEditable', value: 'true'}]);
          appendToTableRow(row, elem.checked, ['checked-state'], []);
        }
      }
      for (cell of tableBody.querySelectorAll('.checked-state')) {
        cell.addEventListener('click', function(e) {
          toggleChecked(e.target);
        });
      }
    }

    var deleteData = function() {
      checkedAll = false;
      formatted = false;
      tableBody = document.getElementById("opfData").getElementsByTagName('tbody')[0];
      while (tableBody.firstChild) {
        tableBody.removeChild(tableBody.firstChild);
      }
    }

    var deleteFormatData = function() {
      checkedAll = false;
      formatted = false;
      elems = [].concat(Array.from(document.getElementsByClassName('formatted')), Array.from(document.getElementsByClassName('checked-state')));
      for (elem of elems) {
        elem.parentNode.removeChild(elem);
      }
    }

    var cleanPrefix = function(number) {
      // Remove 1 leading zero if present (local number)
      if (number.slice(0,1) == '0' && number.slice(1,2) != '0') {
        number = spliceSlice(number, 0, 1);
      }
      // Replace 2 leading zero's with '+' if present (international prefix)
      else if (number.slice(0,2) == '00') 
        number = spliceSlice(number, 0, 2, '+');

      return(number)
    }

    function spliceSlice(str, index, count, add) {
      if (!add) add = '';
      return str.slice(0, index) + add + str.slice(index + count);
    }
    
    var toggleChecked = function(cell, manual, state) {
      parent = cell.parentElement;
      index = parent.getAttribute('index');
      subIndex = parent.getAttribute('subIndex');
      elem = opfData.find(function(searchElem) {
        return searchElem.index == index && searchElem.subIndex == subIndex;
      });

      if (manual) {
        elem.checked = state;
      } else {
        elem.checked = !elem.checked;
      }

      if (elem.checked) {
        cell.classList.add('checked');
      } else {
        cell.classList.remove('checked');
      }
      cell.innerHTML = elem.checked;      
    }

    var toggleCheckedAll = function() {
      checkedAll = !checkedAll;
      for (cell of tableBody.querySelectorAll('.checked-state')) {
        toggleChecked(cell, true, checkedAll);
      }
    }
  </script>
  </body>
</html>
